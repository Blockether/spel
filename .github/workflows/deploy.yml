name: Deploy to Clojars

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: DeLaGuardo/setup-clojure@13.5
        with:
          cli: latest

      - name: Cache Clojure deps
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
            ~/.clojure/.cpcache
          key: clojars-deploy-${{ hashFiles('deps.edn') }}

      - name: Build & Deploy to Clojars
        env:
          VERSION: ${{ github.ref_name }}
          CLOJARS_USERNAME: blockether-deployer
          CLOJARS_PASSWORD: ${{ secrets.CLOJARS_DEPLOY_TOKEN }}
        run: clojure -T:build deploy

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG=$(git tag --sort=-v:refname | head -n 2 | tail -n 1)
          CURRENT_TAG=${{ github.ref_name }}

          if [ -z "$PREV_TAG" ] || [ "$PREV_TAG" = "$CURRENT_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" $CURRENT_TAG)
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" ${PREV_TAG}..${CURRENT_TAG})
          fi

          echo "## What's Changed" > /tmp/release_body.md
          echo "" >> /tmp/release_body.md
          echo "$CHANGELOG" >> /tmp/release_body.md
          echo "" >> /tmp/release_body.md
          echo "**Full Changelog**: https://github.com/Blockether/spel/compare/${PREV_TAG}...${CURRENT_TAG}" >> /tmp/release_body.md

      - name: Update README.md version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          sed -i "s/{:mvn\/version \"[^\"]*\"}/{:mvn\/version \"$VERSION\"}/g" README.md

      - name: Update CHANGELOG.md
        run: |
          PREV_TAG=$(git tag --sort=-v:refname | head -n 2 | tail -n 1)
          CURRENT_TAG=${{ github.ref_name }}
          DATE=$(date +%Y-%m-%d)
          
          if [ -z "$PREV_TAG" ] || [ "$PREV_TAG" = "$CURRENT_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s" $CURRENT_TAG)
          else
            COMMITS=$(git log --pretty=format:"- %s" ${PREV_TAG}..${CURRENT_TAG})
          fi
          
          UNRELEASED_LINE=$(grep -n '^## \[Unreleased\]' CHANGELOG.md | head -1 | cut -d: -f1)
          
          if [ -z "$UNRELEASED_LINE" ]; then
            echo "ERROR: Could not find ## [Unreleased] section in CHANGELOG.md"
            exit 1
          fi
          
          {
            head -n "$UNRELEASED_LINE" CHANGELOG.md
            echo ""
            echo "## [$CURRENT_TAG] - $DATE"
            echo ""
            echo "### Changed"
            echo "$COMMITS"
            echo ""
            tail -n +$((UNRELEASED_LINE + 1)) CHANGELOG.md
          } > CHANGELOG.md.tmp && mv CHANGELOG.md.tmp CHANGELOG.md
          
          sed -i "s|\[Unreleased\]: .*|[Unreleased]: https://github.com/Blockether/spel/compare/${CURRENT_TAG}...HEAD|" CHANGELOG.md
          
          if ! grep -q "^\[${CURRENT_TAG}\]:" CHANGELOG.md; then
            echo "[$CURRENT_TAG]: https://github.com/Blockether/spel/releases/tag/${CURRENT_TAG}" >> CHANGELOG.md
          fi

      - name: Bump SPEL_VERSION to next patch
        run: |
          CURRENT="${GITHUB_REF_NAME#v}"
          MAJOR=$(echo "$CURRENT" | cut -d. -f1)
          MINOR=$(echo "$CURRENT" | cut -d. -f2)
          PATCH=$(echo "$CURRENT" | cut -d. -f3)
          NEXT_PATCH=$((PATCH + 1))
          NEXT_VERSION="${MAJOR}.${MINOR}.${NEXT_PATCH}"
          echo "$NEXT_VERSION" > resources/SPEL_VERSION
          echo "Bumped SPEL_VERSION to $NEXT_VERSION"

      - name: Commit version updates
        run: |
          git config user.name "blockether-deployer"
          git config user.email "contact@blockether.com"
          git add README.md CHANGELOG.md resources/SPEL_VERSION
          git commit -m "release: update version files for ${{ github.ref_name }}, bump to next dev version" || echo "No changes to commit"
          git push origin HEAD:main
