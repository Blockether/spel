name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact: spel-dev-linux-amd64
          - os: macos-latest
            artifact: spel-dev-macos-arm64
          - os: windows-latest
            artifact: spel-dev-windows-amd64

    runs-on: ${{ matrix.os }}
    name: CI (${{ matrix.os }})
    defaults:
      run:
        shell: bash
    env:
      # Normalize Playwright browser path across all OSes (macOS default differs)
      PLAYWRIGHT_BROWSERS_PATH: ~/.cache/ms-playwright

    steps:
      - uses: actions/checkout@v4

      - name: Setup GraalVM
        uses: graalvm/setup-graalvm@v1
        with:
          java-version: '25'
          distribution: 'graalvm'

      - uses: DeLaGuardo/setup-clojure@13.5
        with:
          cli: latest

      - uses: clojure-lsp/setup-clojure-lsp@v1
        with:
          clojure-lsp-version: 2025.11.28-12.47.43

      - name: Cache Clojure deps
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
            ~/.clojure/.cpcache
          key: ${{ runner.os }}-ci-${{ hashFiles('deps.edn') }}
          restore-keys: |
            ${{ runner.os }}-ci-

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('deps.edn') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Install Playwright browsers
        # Use Java driver CLI so browser versions match the library exactly
        run: clojure -M -e "(com.microsoft.playwright.CLI/main (into-array String [\"install\" \"--with-deps\"]))"

      - name: Check Clojure syntax
        run: clojure -M -e "(println \"Syntax check passed\")"

      - name: Lint (clojure-lsp)
        if: runner.os == 'Linux'
        run: make lint

      - name: Validate GraalVM native-image safety
        if: runner.os == 'Linux'
        run: make validate-safe-graal

      - name: Run tests
        run: clojure -M:test

      - name: Build jar
        run: clojure -T:build jar

      - name: Build spel native image
        run: clojure -T:build native-image

      - name: CLI smoke tests (Unix)
        if: runner.os != 'Windows'
        run: |
          chmod +x target/spel
          echo "=== spel --help ==="
          target/spel --help
          echo "=== spel version ==="
          target/spel version
          echo "=== spel open --help (per-command help) ==="
          target/spel open --help
          echo "=== spel snapshot --help ==="
          target/spel snapshot --help
          echo "=== spel find --help ==="
          target/spel find --help
          echo "=== spel network --help ==="
          target/spel network --help
          echo "=== spel -h (bare short flag) ==="
          target/spel -h
          echo "=== All CLI smoke tests passed ==="

      - name: CLI smoke tests (Windows)
        if: runner.os == 'Windows'
        run: |
          echo "=== spel --help ==="
          target/spel.exe --help
          echo "=== spel version ==="
          target/spel.exe version
          echo "=== spel open --help (per-command help) ==="
          target/spel.exe open --help
          echo "=== spel snapshot --help ==="
          target/spel.exe snapshot --help
          echo "=== spel find --help ==="
          target/spel.exe find --help
          echo "=== spel network --help ==="
          target/spel.exe network --help
          echo "=== spel -h (bare short flag) ==="
          target/spel.exe -h
          echo "=== All CLI smoke tests passed ==="

      - name: Upload spel binary (Unix)
        if: runner.os != 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: target/spel

      - name: Upload spel binary (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: target/spel.exe
