name: Allure Report

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write
  checks: write

concurrency:
  group: pages
  cancel-in-progress: false

env:
  PAGES_BASE_URL: https://blockether.github.io/spel
  MAX_REPORTS: 10

jobs:
  report:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - uses: DeLaGuardo/setup-clojure@13.5
        with:
          cli: latest

      - name: Cache Clojure deps
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
            ~/.clojure/.cpcache
          key: allure-${{ hashFiles('deps.edn') }}
          restore-keys: allure-

      - name: Install Playwright browsers
        run: clojure -M -e "(com.microsoft.playwright.CLI/main (into-array String [\"install\" \"--with-deps\"]))"

      - name: Restore Allure history
        uses: actions/cache/restore@v4
        with:
          path: .allure-history.jsonl
          key: allure-history-jsonl-${{ github.run_number }}
          restore-keys: allure-history-jsonl-

      - name: Restore previous reports
        if: github.ref == 'refs/heads/main'
        uses: actions/cache/restore@v4
        with:
          path: gh-pages-site
          key: allure-site-${{ github.run_number }}
          restore-keys: allure-site-

      - name: Run tests with Allure reporter
        id: tests
        env:
          LAZYTEST_ALLURE_LOGO: logo.svg
          FULL_MSG: ${{ github.event.head_commit.message }}
        run: |
          FIRST_LINE=$(echo "$FULL_MSG" | head -n1 | cut -c1-100)
          export LAZYTEST_ALLURE_REPORT_NAME="#${{ github.run_number }} · $(echo '${{ github.sha }}' | cut -c1-8) · ${FIRST_LINE}"
          clojure -M:test --output nested --output com.blockether.spel.allure-reporter/allure
        continue-on-error: true

      - name: Inject report URL and commit info into history
        if: github.ref == 'refs/heads/main'
        env:
          REPORT_URL: ${{ env.PAGES_BASE_URL }}/${{ github.run_number }}
          COMMIT_SHA: ${{ github.sha }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          RUN_NUMBER: ${{ github.run_number }}
        run: |
          if [ -f .allure-history.jsonl ]; then
            python3 -c "
          import json, os
          report_url = os.environ['REPORT_URL']
          sha = os.environ.get('COMMIT_SHA', '')[:8]
          msg = os.environ.get('COMMIT_MSG', '').split('\n')[0][:100]
          run = os.environ.get('RUN_NUMBER', '')
          name = f'#{run} \u00b7 {sha} \u00b7 {msg}'
          lines = open('.allure-history.jsonl').read().strip().split('\n')
          result = []
          for i, line in enumerate(lines):
              if not line.strip():
                  continue
              entry = json.loads(line)
              if i == len(lines) - 1:
                  entry['url'] = report_url
                  entry['name'] = name
                  for tid in entry.get('testResults', {}):
                      entry['testResults'][tid]['url'] = report_url
              result.append(json.dumps(entry, separators=(',', ':')))
          with open('.allure-history.jsonl', 'w') as f:
              f.write('\n'.join(result) + '\n')
          "
            echo "Injected URL ${REPORT_URL} and commit info into latest history entry"
          fi

      - name: Assemble site with per-build reports
        if: github.ref == 'refs/heads/main'
        env:
          RUN_NUMBER: ${{ github.run_number }}
          COMMIT_SHA: ${{ github.sha }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          COMMIT_TS: ${{ github.event.head_commit.timestamp }}
          TEST_PASSED: ${{ steps.tests.outcome == 'success' }}
          REPO_URL: ${{ github.server_url }}/${{ github.repository }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          RUN="${{ github.run_number }}"
          mkdir -p gh-pages-site
          cp -r allure-report "gh-pages-site/${RUN}"
          echo "Added report #${RUN}"

          cd gh-pages-site

          # Prune oldest reports beyond MAX_REPORTS
          DIRS=$(ls -1d [0-9]* 2>/dev/null | sort -n)
          COUNT=$(echo "$DIRS" | grep -c .)
          if [ "$COUNT" -gt "$MAX_REPORTS" ]; then
            REMOVE=$((COUNT - MAX_REPORTS))
            echo "$DIRS" | head -n "$REMOVE" | while read -r dir; do
              echo "Pruning old report: $dir"
              rm -rf "$dir"
            done
          fi

          # Generate builds.json from available report dirs + metadata cache
          BUILDS_META="builds-meta.json"
          [ -f "$BUILDS_META" ] || echo '{}' > "$BUILDS_META"

          python3 -c "
          import json, os, time
          meta_file = '$BUILDS_META'
          meta = json.load(open(meta_file))
          run = os.environ['RUN_NUMBER']
          sha = os.environ.get('COMMIT_SHA', '')
          msg = os.environ.get('COMMIT_MSG', '').split('\n')[0]
          ts_str = os.environ.get('COMMIT_TS', '')
          ts = int(time.time() * 1000)
          if ts_str:
              from datetime import datetime
              try:
                  dt = datetime.fromisoformat(ts_str.replace('Z', '+00:00'))
                  ts = int(dt.timestamp() * 1000)
              except Exception:
                  pass
          passed = os.environ.get('TEST_PASSED', 'false') == 'true'
          repo_url = os.environ.get('REPO_URL', '')
          run_url = os.environ.get('RUN_URL', '')
          meta[run] = {'sha': sha, 'message': msg, 'timestamp': ts, 'passed': passed, 'repo_url': repo_url, 'run_url': run_url}
          dirs = sorted([d for d in os.listdir('.') if d.isdigit()], key=int, reverse=True)
          pruned = {k: v for k, v in meta.items() if k in dirs}
          json.dump(pruned, open(meta_file, 'w'), separators=(',', ':'))
          builds = []
          for d in dirs:
              entry = pruned.get(d, {})
              builds.append({'run': d, 'sha': entry.get('sha', ''), 'message': entry.get('message', ''), 'timestamp': entry.get('timestamp', 0), 'passed': entry.get('passed', True), 'repo_url': entry.get('repo_url', ''), 'run_url': entry.get('run_url', '')})
          json.dump(builds, open('builds.json', 'w'), separators=(',', ':'))
          print(f'Generated builds.json with {len(builds)} entries')
          "

          cp ../resources/allure-index.html index.html
          python3 -c "
          import re, os
          html = open('index.html').read()

          # Logo: inject SVG from file if present
          logo_file = '../logo.svg'
          if os.path.isfile(logo_file):
              logo = open(logo_file).read()
              logo = logo.replace('viewBox=\"0 0 400 350\"', 'viewBox=\"60 10 280 230\"')
              logo = logo.replace('width=\"400\" height=\"350\"', '')
              html = html.replace('<!--LOGO_PLACEHOLDER-->', logo)

          # Title & subtitle: replace between placeholder markers if env vars set
          title = os.environ.get('LANDING_TITLE', '')
          subtitle = os.environ.get('LANDING_SUBTITLE', '')
          if title:
              html = re.sub(r'<!--TITLE_PLACEHOLDER-->.*?<!--/TITLE_PLACEHOLDER-->', title, html)
          if subtitle:
              html = re.sub(r'<!--SUBTITLE_PLACEHOLDER-->.*?<!--/SUBTITLE_PLACEHOLDER-->', subtitle, html)

          open('index.html', 'w').write(html)
          "

          mkdir -p latest
          cat > latest/index.html <<EOF
          <!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="refresh" content="0; url=../${RUN}/"></head><body></body></html>
          EOF

          cd ..
          echo "Site ready with $(ls -1d gh-pages-site/[0-9]* 2>/dev/null | wc -l) reports"

      - name: Cache Allure history
        if: github.ref == 'refs/heads/main'
        uses: actions/cache/save@v4
        with:
          path: .allure-history.jsonl
          key: allure-history-jsonl-${{ github.run_number }}

      - name: Cache site archive
        if: github.ref == 'refs/heads/main'
        uses: actions/cache/save@v4
        with:
          path: gh-pages-site
          key: allure-site-${{ github.run_number }}

      - name: Upload Pages artifact
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-pages-artifact@v3
        with:
          path: gh-pages-site

      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main'
        id: deployment
        uses: actions/deploy-pages@v4
