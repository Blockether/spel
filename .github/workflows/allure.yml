name: Allure Report

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write
  checks: write

concurrency:
  group: pages
  cancel-in-progress: false

env:
  PAGES_BASE_URL: https://blockether.github.io/spel
  MAX_REPORTS: 10

jobs:
  report:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - uses: DeLaGuardo/setup-clojure@13.5
        with:
          cli: latest

      - name: Cache Clojure deps
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
            ~/.clojure/.cpcache
          key: allure-${{ hashFiles('deps.edn') }}
          restore-keys: allure-

      - name: Install Playwright browsers
        run: clojure -M -e "(com.microsoft.playwright.CLI/main (into-array String [\"install\" \"--with-deps\"]))"

      - name: Restore Allure history
        uses: actions/cache/restore@v4
        with:
          path: .allure-history.jsonl
          key: allure-history-jsonl-${{ github.run_number }}
          restore-keys: allure-history-jsonl-

      - name: Restore previous reports
        if: github.ref == 'refs/heads/main'
        uses: actions/cache/restore@v4
        with:
          path: gh-pages-site
          key: allure-site-${{ github.run_number }}
          restore-keys: allure-site-

      - name: Run tests with Allure reporter
        env:
          LAZYTEST_ALLURE_REPORT_NAME: "#${{ github.run_number }} · ${{ github.sha }} · ${{ github.event.head_commit.message }}"
        run: clojure -M:test --output nested --output com.blockether.spel.allure-reporter/allure
        continue-on-error: true

      - name: Inject report URL and commit info into history
        if: github.ref == 'refs/heads/main'
        env:
          REPORT_URL: ${{ env.PAGES_BASE_URL }}/${{ github.run_number }}
          COMMIT_SHA: ${{ github.sha }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          RUN_NUMBER: ${{ github.run_number }}
        run: |
          if [ -f .allure-history.jsonl ]; then
            python3 -c "
          import json, os
          report_url = os.environ['REPORT_URL']
          sha = os.environ.get('COMMIT_SHA', '')[:8]
          msg = os.environ.get('COMMIT_MSG', '').split('\n')[0][:100]
          run = os.environ.get('RUN_NUMBER', '')
          name = f'#{run} \u00b7 {sha} \u00b7 {msg}'
          lines = open('.allure-history.jsonl').read().strip().split('\n')
          result = []
          for i, line in enumerate(lines):
              if not line.strip():
                  continue
              entry = json.loads(line)
              if i == len(lines) - 1:
                  entry['url'] = report_url
                  entry['name'] = name
                  for tid in entry.get('testResults', {}):
                      entry['testResults'][tid]['url'] = report_url
              result.append(json.dumps(entry, separators=(',', ':')))
          with open('.allure-history.jsonl', 'w') as f:
              f.write('\n'.join(result) + '\n')
          "
            echo "Injected URL ${REPORT_URL} and commit info into latest history entry"
          fi

      - name: Assemble site with per-build reports
        if: github.ref == 'refs/heads/main'
        run: |
          RUN="${{ github.run_number }}"
          mkdir -p gh-pages-site
          cp -r allure-report "gh-pages-site/${RUN}"
          echo "Added report #${RUN}"

          cd gh-pages-site
          DIRS=$(ls -1d [0-9]* 2>/dev/null | sort -n)
          COUNT=$(echo "$DIRS" | grep -c .)
          if [ "$COUNT" -gt "$MAX_REPORTS" ]; then
            REMOVE=$((COUNT - MAX_REPORTS))
            echo "$DIRS" | head -n "$REMOVE" | while read -r dir; do
              echo "Pruning old report: $dir"
              rm -rf "$dir"
            done
          fi

          LATEST="$RUN"
          LINKS=""
          for dir in $(ls -1d [0-9]* 2>/dev/null | sort -rn); do
            if [ "$dir" = "$LATEST" ]; then
              LINKS="${LINKS}<a href=\"${dir}/\"><b>#${dir} (latest)</b></a> "
            else
              LINKS="${LINKS}<a href=\"${dir}/\">#${dir}</a> "
            fi
          done

          cat > index.html <<EOF
          <!DOCTYPE html><html><head>
          <meta charset="utf-8">
          <meta http-equiv="refresh" content="0; url=${LATEST}/">
          <title>Allure Report - spel</title>
          <style>body{font-family:system-ui,sans-serif;display:flex;justify-content:center;align-items:center;height:100vh;margin:0;background:#1a1a2e;color:#eee}a{color:#7eb6ff}</style>
          </head><body><div style="text-align:center">
          <p>Redirecting to <a href="${LATEST}/">latest report (#${LATEST})</a>...</p>
          <p style="margin-top:2em;font-size:0.85em;color:#999">Previous reports: ${LINKS}</p>
          </div></body></html>
          EOF
          cd ..
          echo "Site ready with $(ls -1d gh-pages-site/[0-9]* 2>/dev/null | wc -l) reports"

      - name: Cache Allure history
        if: github.ref == 'refs/heads/main'
        uses: actions/cache/save@v4
        with:
          path: .allure-history.jsonl
          key: allure-history-jsonl-${{ github.run_number }}

      - name: Cache site archive
        if: github.ref == 'refs/heads/main'
        uses: actions/cache/save@v4
        with:
          path: gh-pages-site
          key: allure-site-${{ github.run_number }}

      - name: Upload Pages artifact
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-pages-artifact@v3
        with:
          path: gh-pages-site

      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main'
        id: deployment
        uses: actions/deploy-pages@v4
