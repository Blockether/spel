name: Allure Report

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write
  checks: write

concurrency:
  group: pages
  cancel-in-progress: false

env:
  PAGES_BASE_URL: https://blockether.github.io/spel
  MAX_REPORTS: 10

jobs:
  report:
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'github-pages' || '' }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - uses: DeLaGuardo/setup-clojure@13.5
        with:
          cli: latest

      - name: Cache Clojure deps
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
            ~/.clojure/.cpcache
          key: allure-${{ hashFiles('deps.edn') }}
          restore-keys: allure-

      - name: Install Playwright browsers
        run: clojure -M -e "(com.microsoft.playwright.CLI/main (into-array String [\"install\" \"--with-deps\"]))"

      - name: Restore Allure history
        uses: actions/cache/restore@v4
        with:
          path: .allure-history.jsonl
          key: allure-history-jsonl-${{ github.run_number }}
          restore-keys: allure-history-jsonl-

      - name: Restore previous reports
        if: github.ref == 'refs/heads/main'
        uses: actions/cache/restore@v4
        with:
          path: gh-pages-site
          key: allure-site-${{ github.run_number }}
          restore-keys: allure-site-

      - name: Detect version
        id: version
        run: |
          VERSION=$(cat resources/SPEL_VERSION 2>/dev/null || echo "unknown")
          TAG=$(git describe --tags --exact-match 2>/dev/null || echo "")
          if [ -n "$TAG" ]; then
            echo "version=$TAG" >> $GITHUB_OUTPUT
            echo "badge=release" >> $GITHUB_OUTPUT
          else
            echo "version=v${VERSION}-candidate" >> $GITHUB_OUTPUT
            echo "badge=candidate" >> $GITHUB_OUTPUT
          fi

      - name: Clean Allure results before test run
        run: rm -rf allure-results allure-report

      - name: Run lazytest suite with Allure reporter
        id: tests-lazytest
        env:
          LAZYTEST_ALLURE_GENERATE_REPORT: "false"
          FULL_MSG: ${{ github.event.head_commit.message }}
        run: |
          FIRST_LINE=$(echo "$FULL_MSG" | head -n1 | cut -c1-100)
          export LAZYTEST_ALLURE_REPORT_NAME="#${{ github.run_number }} 路 $(echo '${{ github.sha }}' | cut -c1-8) 路 ${FIRST_LINE}"
          clojure -M:test --output nested --output com.blockether.spel.allure-reporter/allure
        continue-on-error: true

      - name: Run clojure.test suite with Allure reporter
        id: tests-ct
        env:
          ALLURE_CLOJURE_TEST_ENABLED: "true"
          ALLURE_CLOJURE_TEST_CLEAN: "false"
          ALLURE_CLOJURE_TEST_REPORT: "false"
        run: clojure -M:test-ct
        continue-on-error: true

      - name: Generate combined Allure report
        env:
          LAZYTEST_ALLURE_LOGO: logo.svg
          FULL_MSG: ${{ github.event.head_commit.message }}
        run: |
          FIRST_LINE=$(echo "$FULL_MSG" | head -n1 | cut -c1-100)
          export LAZYTEST_ALLURE_REPORT_NAME="#${{ github.run_number }} 路 $(echo '${{ github.sha }}' | cut -c1-8) 路 ${FIRST_LINE}"
          clojure -M -e "
            (require '[com.blockether.spel.allure-reporter :as r])
            (r/generate-html-report! \"allure-results\" \"allure-report\")"

      - name: Upload Allure report artifact (PR/branch)
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-pr-${{ github.event.pull_request.number }}
          path: allure-report/
          retention-days: 7

      - name: Comment PR with report link
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            const comment = `##  Allure Report\n\nTest report generated for this PR.\n\n[Download Allure Report Artifact](${runUrl})\n\n- Lazytest: ${{ steps.tests-lazytest.outcome }}\n- CT: ${{ steps.tests-ct.outcome }}`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Inject report URL and commit info into history
        if: github.ref == 'refs/heads/main'
        env:
          REPORT_URL: ${{ env.PAGES_BASE_URL }}/${{ github.run_number }}
          COMMIT_SHA: ${{ github.sha }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          COMMIT_AUTHOR: ${{ github.event.head_commit.author.name }}
          RUN_NUMBER: ${{ github.run_number }}
        run: |
          if [ -f .allure-history.jsonl ]; then
            clojure -M -e "
              (require '[com.blockether.spel.ci :as ci])
              (ci/patch-allure-history!
                {:history-file \".allure-history.jsonl\"
                 :report-url   (System/getenv \"REPORT_URL\")
                 :commit-sha   (System/getenv \"COMMIT_SHA\")
                 :commit-msg   (System/getenv \"COMMIT_MSG\")
                 :run-number   (System/getenv \"RUN_NUMBER\")})"
          fi

      - name: Extract test counts from Allure results
        id: test-counts
        run: |
          PASSED=$(grep -l '"status": *"passed"' allure-results/*-result.json 2>/dev/null | wc -l | tr -d ' ')
          FAILED=$(grep -l '"status": *"failed"' allure-results/*-result.json 2>/dev/null | wc -l | tr -d ' ')
          BROKEN=$(grep -l '"status": *"broken"' allure-results/*-result.json 2>/dev/null | wc -l | tr -d ' ')
          SKIPPED=$(grep -l '"status": *"skipped"' allure-results/*-result.json 2>/dev/null | wc -l | tr -d ' ')
          TOTAL=$((PASSED + FAILED + BROKEN + SKIPPED))
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "broken=$BROKEN" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "Test counts: passed=$PASSED, failed=$FAILED, broken=$BROKEN, skipped=$SKIPPED, total=$TOTAL"

      - name: Assemble site with per-build reports
        if: github.ref == 'refs/heads/main'
        env:
          RUN_NUMBER: ${{ github.run_number }}
          COMMIT_SHA: ${{ github.sha }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          COMMIT_AUTHOR: ${{ github.event.head_commit.author.name }}
          COMMIT_TS: ${{ github.event.head_commit.timestamp }}
          TEST_PASSED: ${{ steps.tests-lazytest.outcome == 'success' && steps.tests-ct.outcome == 'success' }}
          REPO_URL: ${{ github.server_url }}/${{ github.repository }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          VERSION: ${{ steps.version.outputs.version }}
          VERSION_BADGE: ${{ steps.version.outputs.badge }}
          TEST_COUNTS_PASSED: ${{ steps.test-counts.outputs.passed }}
          TEST_COUNTS_FAILED: ${{ steps.test-counts.outputs.failed }}
          TEST_COUNTS_BROKEN: ${{ steps.test-counts.outputs.broken }}
          TEST_COUNTS_SKIPPED: ${{ steps.test-counts.outputs.skipped }}
          TEST_COUNTS_TOTAL: ${{ steps.test-counts.outputs.total }}
        run: |
          RUN="${{ github.run_number }}"
          mkdir -p gh-pages-site
          cp -r allure-report "gh-pages-site/${RUN}"
          echo "Added report #${RUN}"

          cd gh-pages-site

          # Prune oldest reports beyond MAX_REPORTS
          DIRS=$(ls -1d [0-9]* 2>/dev/null | sort -n)
          COUNT=$(echo "$DIRS" | grep -c .)
          if [ "$COUNT" -gt "$MAX_REPORTS" ]; then
            REMOVE=$((COUNT - MAX_REPORTS))
            echo "$DIRS" | head -n "$REMOVE" | while read -r dir; do
              echo "Pruning old report: $dir"
              rm -rf "$dir"
            done
          fi

          # Generate builds metadata + patch index.html (Clojure replaces Python)
          [ -f "builds-meta.json" ] || echo '{}' > "builds-meta.json"
          cp ../resources/allure-index.html index.html
          cd ..
          clojure -M -e "
            (require '[com.blockether.spel.ci :as ci])
            (ci/generate-builds-metadata!
              {:site-dir       \"gh-pages-site\"
               :run-number     (System/getenv \"RUN_NUMBER\")
               :commit-sha     (System/getenv \"COMMIT_SHA\")
               :commit-msg     (System/getenv \"COMMIT_MSG\")
               :commit-author  (System/getenv \"COMMIT_AUTHOR\")
               :commit-ts      (System/getenv \"COMMIT_TS\")
               :tests-passed   (= \"true\" (System/getenv \"TEST_PASSED\"))
               :repo-url       (System/getenv \"REPO_URL\")
               :run-url        (System/getenv \"RUN_URL\")
               :version        (System/getenv \"VERSION\")
               :version-badge  (System/getenv \"VERSION_BADGE\")
               :test-counts    {:passed  (parse-long (or (System/getenv \"TEST_COUNTS_PASSED\") \"0\"))
                                :failed  (parse-long (or (System/getenv \"TEST_COUNTS_FAILED\") \"0\"))
                                :broken  (parse-long (or (System/getenv \"TEST_COUNTS_BROKEN\") \"0\"))
                                :skipped (parse-long (or (System/getenv \"TEST_COUNTS_SKIPPED\") \"0\"))
                                :total   (parse-long (or (System/getenv \"TEST_COUNTS_TOTAL\") \"0\"))}})
            (ci/patch-index-html!
              {:index-file \"gh-pages-site/index.html\"
               :logo-file  \"logo.svg\"
               :title      (System/getenv \"LANDING_TITLE\")
               :subtitle   (System/getenv \"LANDING_SUBTITLE\")})"
          cd gh-pages-site

          mkdir -p latest
          cat > latest/index.html <<EOF
          <!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="refresh" content="0; url=../${RUN}/"></head><body></body></html>
          EOF

          # Copy badge.svg from latest report to root for README consumption
          if [ -f "${RUN}/badge.svg" ]; then
            cp "${RUN}/badge.svg" badge.svg
            echo "Copied badge.svg to site root"
          fi

          cd ..
          echo "Site ready with $(ls -1d gh-pages-site/[0-9]* 2>/dev/null | wc -l) reports"

      - name: Cache Allure history
        if: github.ref == 'refs/heads/main'
        uses: actions/cache/save@v4
        with:
          path: .allure-history.jsonl
          key: allure-history-jsonl-${{ github.run_number }}

      - name: Cache site archive
        if: github.ref == 'refs/heads/main'
        uses: actions/cache/save@v4
        with:
          path: gh-pages-site
          key: allure-site-${{ github.run_number }}

      - name: Upload Pages artifact
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-pages-artifact@v3
        with:
          path: gh-pages-site

      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main'
        id: deployment
        uses: actions/deploy-pages@v4
