<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Test Reports ¬∑ spel</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé≠</text></svg>">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #f8f9fb; --bg-card: #fff; --bg-card-hover: #f6f7f9;
      --border: #e2e5ea; --border-hover: #cdd1d8;
      --text: #1a1d23; --text-sec: #5a6070; --text-muted: #8b92a0;
      --green: #2EAD33; --green-bg: rgba(46,173,51,0.06); --green-border: rgba(46,173,51,0.2);
      --green-text: #1d7a22; --red: #d94040; --red-bg: rgba(217,64,64,0.05); --red-border: rgba(217,64,64,0.2);
      --red-text: #b33030; --code-bg: #eef0f4; --code-text: #5a6070;
      --shadow: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.03);
      --shadow-h: 0 4px 12px rgba(0,0,0,0.06), 0 1px 3px rgba(0,0,0,0.04);
    }
    html.dark {
      --bg: #0f1219; --bg-card: #1a2030; --bg-card-hover: #1f2738;
      --border: #2a3142; --border-hover: #3a4358;
      --text: #e8eaf0; --text-sec: #9ba3b5; --text-muted: #5f6880;
      --green-bg: rgba(46,173,51,0.08); --green-border: rgba(46,173,51,0.25);
      --green-text: #4cd952; --red-bg: rgba(217,64,64,0.08); --red-border: rgba(217,64,64,0.25);
      --red-text: #f06060; --code-bg: #252d3d; --code-text: #9ba3b5;
      --shadow: 0 1px 3px rgba(0,0,0,0.2); --shadow-h: 0 4px 16px rgba(0,0,0,0.3);
    }
    body { font-family: system-ui, -apple-system, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; -webkit-font-smoothing: antialiased; }
    @keyframes fade-in { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    .header { padding: 1.5rem 1rem 1rem; text-align: center; }
    .logo { width: 64px; height: 64px; margin: 0 auto; opacity: 0.9; }
    .logo svg { width: 100%; height: 100%; }
    .title { font-family: 'Iowan Old Style', 'Palatino Linotype', Palatino, Georgia, serif; font-size: 1.75rem; font-weight: 700; letter-spacing: 0.05em; margin-bottom: 0.2rem; }
    .subtitle { font-size: 0.7rem; color: var(--text-muted); letter-spacing: 0.15em; text-transform: uppercase; }

    .main { max-width: 52rem; margin: 0 auto; padding: 0.5rem 1.5rem 3rem; }
    .builds { display: flex; flex-direction: column; gap: 0.5rem; }

    .date-group { font-size: 0.7rem; font-weight: 600; color: var(--text-muted); letter-spacing: 0.06em; text-transform: uppercase; padding: 0.75rem 0.25rem 0.35rem; border-bottom: 1px solid var(--border); margin-top: 0.5rem; }
    .date-group:first-child { margin-top: 0; }

    .card { display: flex; align-items: center; gap: 1rem; padding: 0.875rem 1.25rem; border-radius: 0.75rem; border: 1px solid var(--border); background: var(--bg-card); box-shadow: var(--shadow); text-decoration: none; color: inherit; transition: all 0.2s ease; animation: fade-in 0.4s ease-out both; cursor: pointer; }
    .card:hover { border-color: var(--border-hover); background: var(--bg-card-hover); box-shadow: var(--shadow-h); transform: translateY(-1px); }
    .card.failed { border-color: var(--red-border); background: var(--red-bg); }
    .card.failed:hover { border-color: var(--red); }

    .run { flex-shrink: 0; width: 3.5rem; text-align: center; }
    .run-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); }
    .run-num { font-size: 1.4rem; font-weight: 700; font-variant-numeric: tabular-nums; color: var(--text); }
    a.run-link { text-decoration: none; color: var(--text); transition: color 0.2s; }
    a.run-link:hover { color: var(--green); }
    .status-dot { flex-shrink: 0; width: 1.25rem; font-size: 0.75rem; text-align: center; font-weight: 700; line-height: 1; }
    .status-pass { color: var(--green); }
    .status-fail { color: var(--red); }
    .divider { width: 1px; height: 2.5rem; background: var(--border); flex-shrink: 0; }
    .failed .divider { background: var(--red-border); }

    .info { flex: 1; min-width: 0; }
    .info-top { display: flex; align-items: center; gap: 0.4rem; margin-bottom: 0.25rem; }
    .sha { display: inline-block; padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-size: 0.7rem; font-family: 'SF Mono', 'Fira Code', Consolas, monospace; background: var(--code-bg); color: var(--code-text); }
    .sha-link { text-decoration: none; transition: background 0.2s, color 0.2s; }
    .sha-link:hover { background: var(--border-hover); color: var(--text); }
    .failed .sha { background: var(--red-bg); color: var(--red-text); }
    .failed .sha-link:hover { background: var(--red-border); color: var(--red-text); }
    .msg { font-size: 0.82rem; color: var(--text-sec); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .author { margin: 0.1rem 0 0; font-size: 0.72rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .meta { flex-shrink: 0; text-align: right; }
    .meta-date { font-size: 0.7rem; color: var(--text-muted); font-variant-numeric: tabular-nums; }
    .meta-rel { font-size: 0.6rem; color: var(--text-muted); opacity: 0.7; font-variant-numeric: tabular-nums; }
    .arrow { width: 1rem; height: 1rem; flex-shrink: 0; color: var(--text-muted); transition: all 0.2s; }
    .card:hover .arrow { color: var(--text-sec); transform: translateX(2px); }

    .empty { display: none; text-align: center; color: var(--text-muted); margin-top: 4rem; font-size: 1rem; }
    .empty.show { display: block; }

    .footer { text-align: center; padding-bottom: 2rem; font-size: 0.7rem; color: var(--text-muted); }
    .footer a { color: var(--text-sec); text-decoration: none; transition: color 0.2s; }
    .footer a:hover { color: var(--green); }

    .theme-toggle { position: fixed; top: 1rem; right: 1rem; width: 2rem; height: 2rem; border-radius: 50%; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-sec); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; z-index: 50; box-shadow: var(--shadow); }
    .theme-toggle:hover { border-color: var(--border-hover); background: var(--bg-card-hover); }
    .theme-toggle svg { width: 1rem; height: 1rem; }
    .theme-toggle .icon-moon { display: none; }
    html.dark .theme-toggle .icon-sun { display: none; }
    html.dark .theme-toggle .icon-moon { display: block; }

    /* Video modal */
    .video-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center; }
    .video-modal.show { display: flex; }
    .video-modal-content { max-width: 90vw; max-height: 90vh; position: relative; }
    .video-modal video { max-width: 100%; max-height: 85vh; border-radius: 8px; background: #000; }
    .video-modal-close { position: absolute; top: -40px; right: 0; background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; padding: 0.5rem; }
    .video-modal-title { position: absolute; bottom: 20px; left: 20px; right: 60px; color: #fff; font-size: 0.9rem; background: rgba(0,0,0,0.6); padding: 0.5rem 1rem; border-radius: 4px; }

    .pill { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.6rem; font-weight: 600; margin-left: 8px; letter-spacing: 0.03em; border: 1px solid; vertical-align: middle; }
    .pill-green { background: var(--green-bg); color: var(--green-text); border-color: var(--green-border); }
    .pill-yellow { background: rgba(255,193,7,0.10); color: #8a6d00; border-color: rgba(255,193,7,0.4); }
    .pill-blue { background: rgba(0,126,198,0.08); color: #006bb3; border-color: rgba(0,126,198,0.3); }
    .pill-red { background: var(--red-bg); color: var(--red-text); border-color: var(--red-border); }
    html.dark .pill-yellow { background: rgba(255,193,7,0.12); color: #ffd54f; border-color: rgba(255,193,7,0.35); }
    html.dark .pill-blue { background: rgba(0,126,198,0.12); color: #64b5f6; border-color: rgba(0,126,198,0.35); }

    .status-in-progress { color: #ffc107; }
    .card.in-progress { border-color: rgba(255,193,7,0.4); background: rgba(255,193,7,0.04); }
    .card.in-progress:hover { border-color: #ffc107; }
    html.dark .card.in-progress { background: rgba(255,193,7,0.06); }
    .pill-in-progress { background: rgba(255,193,7,0.12); color: #8a6d00; border-color: rgba(255,193,7,0.4); animation: pulse 2s infinite; }
    html.dark .pill-in-progress { background: rgba(255,193,7,0.15); color: #ffd54f; border-color: rgba(255,193,7,0.4); }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

    @media (max-width: 640px) { .meta { display: none; } .card { padding: 0.75rem 1rem; gap: 0.75rem; } .info-top { flex-wrap: wrap; gap: 6px; align-items: flex-start; } .pill { margin-left: 0; } }

    /* View toggle */
    .view-toggle { position: fixed; top: 1rem; right: 3.25rem; display: flex; gap: 2px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 2px; z-index: 50; box-shadow: var(--shadow); }
    .view-btn { width: 2rem; height: 2rem; border: none; background: transparent; color: var(--text-muted); cursor: pointer; border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .view-btn:hover { color: var(--text-sec); background: var(--bg-card-hover); }
    .view-btn.active { background: var(--green-bg); color: var(--green-text); }
    .view-btn svg { width: 1rem; height: 1rem; }

    /* Compact view - grid layout with equal-sized cards */
    .builds.compact { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
      gap: 0.5rem; 
    }
    .builds.compact .card { 
      flex-direction: column; 
      padding: 0.75rem; 
      border-radius: 0.5rem; 
      align-items: flex-start;
      min-height: 120px;
    }
    .builds.compact .run { 
      width: 100%; 
      display: flex; 
      align-items: center; 
      justify-content: space-between;
      margin-bottom: 0.25rem;
    }
    .builds.compact .run-label { display: none; }
    .builds.compact .run-num { font-size: 1rem; }
    .builds.compact .status-dot { width: auto; font-size: 0.7rem; }
    .builds.compact .divider { display: none; }
    .builds.compact .info { flex: 1; width: 100%; }
    .builds.compact .info-top { flex-wrap: wrap; margin-bottom: 0.25rem; }
    .builds.compact .sha { padding: 2px 6px; font-size: 0.65rem; }
    .builds.compact .pill { font-size: 0.5rem; padding: 1px 5px; margin-left: 4px; }
    .builds.compact .msg { font-size: 0.75rem; }
    .builds.compact .author { font-size: 0.65rem; margin: 0.15rem 0 0; }
    .builds.compact .meta { display: flex; flex-direction: row; align-items: center; justify-content: space-between; width: 100%; margin-top: auto; }
    .builds.compact .meta-date { font-size: 0.55rem; }
    .builds.compact .meta-rel { font-size: 0.5rem; }
    .builds.compact .arrow { display: none; }
    .builds.compact .date-group { font-size: 0.65rem; padding: 0.5rem 0.25rem 0.25rem; margin-top: 0.35rem; grid-column: 1 / -1; }

    @media (max-width: 640px) {
      .view-toggle { top: 0.75rem; right: 0.75rem; }
      .builds.compact .meta { display: none; }
      .builds.compact .card { padding: 0.5rem 0.6rem; min-height: 100px; }
      .builds.compact { grid-template-columns: repeat(2, 1fr); gap: 0.35rem; }
      .builds.compact .info-top { flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <div class="view-toggle">
    <button class="view-btn active" id="viewColumns" onclick="setView('columns')" title="Column view">
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="18" rx="1"/><rect x="14" y="3" width="7" height="10" rx="1"/></svg>
    </button>
    <button class="view-btn" id="viewCompact" onclick="setView('compact')" title="Compact view">
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="6" rx="1"/><rect x="3" y="11" width="18" height="6" rx="1"/><rect x="3" y="19" width="18" height="2" rx="0.5"/></svg>
    </button>
  </div>
  <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
    <svg class="icon-sun" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
    <svg class="icon-moon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
  </button>

  <header class="header">
    <div class="logo"><!--LOGO_PLACEHOLDER--></div>
    <h1 class="title"><!--TITLE_PLACEHOLDER-->spel<!--/TITLE_PLACEHOLDER--></h1>
    <p class="subtitle"><!--SUBTITLE_PLACEHOLDER-->Clojure √ó Playwright ¬∑ Test Reports<!--/SUBTITLE_PLACEHOLDER--></p>
  </header>

  <main class="main">
    <div id="builds" class="builds"></div>
    <p id="empty" class="empty">No reports yet. Push to main to generate one.</p>
  </main>

  <!-- Video Modal -->
  <div id="videoModal" class="video-modal" onclick="if(event.target === this) closeVideoModal()">
    <div class="video-modal-content">
      <button class="video-modal-close" onclick="closeVideoModal()" title="Close">&times;</button>
      <video id="videoPlayer" controls playsinline></video>
      <div id="videoModalTitle" class="video-modal-title"></div>
    </div>
  </div>

  <footer class="footer">
    Powered by <a href="https://github.com/Blockether/spel">spel</a>
    &middot; Reports by <a href="https://allurereport.org">Allure</a>
  </footer>

  <script>
    // --- localStorage scoping by report path + 30-day auto-cleanup ---
    (function() {
      var THIRTY_DAYS = 30 * 24 * 60 * 60 * 1000;
      var prefix = location.pathname.replace(/\/[^/]*$/, '/') + ':';
      var cleanKey = prefix + '__lastCleaned';

      // Auto-cleanup: clear scoped keys older than 30 days
      try {
        var lastCleaned = parseInt(localStorage.getItem(cleanKey), 10);
        if (!lastCleaned || (Date.now() - lastCleaned) > THIRTY_DAYS) {
          for (var i = localStorage.length - 1; i >= 0; i--) {
            var k = localStorage.key(i);
            if (k && k.indexOf(prefix) === 0) localStorage.removeItem(k);
          }
          localStorage.setItem(cleanKey, String(Date.now()));
        }
      } catch(e) {}

      // Scoped wrappers
      var _getItem = localStorage.getItem.bind(localStorage);
      var _setItem = localStorage.setItem.bind(localStorage);
      var _removeItem = localStorage.removeItem.bind(localStorage);

      window.__spelGetItem = function(key) { return _getItem(prefix + key); };
      window.__spelSetItem = function(key, val) { _setItem(prefix + key, val); };
      window.__spelRemoveItem = function(key) { _removeItem(prefix + key); };
    })();
    (function() {
      // Theme is stored globally (shared across all builds)
      var saved = localStorage.getItem('spel-theme');
      if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches))
        document.documentElement.classList.add('dark');
    })();
    function toggleTheme() {
      var d = document.documentElement.classList.toggle('dark');
      localStorage.setItem('spel-theme', d ? 'dark' : 'light');
    }

    // View mode toggle (global, persisted in localStorage)
    function setView(mode) {
      localStorage.setItem('spel-view', mode);
      document.getElementById('viewColumns').classList.toggle('active', mode === 'columns');
      document.getElementById('viewCompact').classList.toggle('active', mode === 'compact');
      document.getElementById('builds').classList.toggle('compact', mode === 'compact');
    }
    (function() {
      var view = localStorage.getItem('spel-view') || 'columns';
      setView(view);
    })();

    // Video modal functions
    function openVideoModal(src, title) {
      var modal = document.getElementById('videoModal');
      var player = document.getElementById('videoPlayer');
      var titleEl = document.getElementById('videoModalTitle');
      player.src = src;
      titleEl.textContent = title || 'Video Recording';
      modal.classList.add('show');
      player.play();
    }
    function closeVideoModal() {
      var modal = document.getElementById('videoModal');
      var player = document.getElementById('videoPlayer');
      player.pause();
      player.src = '';
      modal.classList.remove('show');
    }
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') closeVideoModal();
    });

    function relativeTime(ts) {
      var diff = Date.now() - ts, m = Math.floor(diff / 60000);
      if (m < 1) return 'just now';
      if (m < 60) return m + 'm ago';
      var h = Math.floor(m / 60);
      if (h < 24) return h + 'h ago';
      var d = Math.floor(h / 24);
      return d < 30 ? d + 'd ago' : null;
    }
    function formatDate(ts) {
      if (!ts) return '';
      var d = new Date(ts);
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
        + ' ' + d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
    }
    function truncate(s, n) {
      if (!s) return '';
      var f = s.split('\n')[0];
      return f.length > n ? f.slice(0, n) + '\u2026' : f;
    }

    function renderBuild(b, i) {
      var sha = (b.sha || '').slice(0, 8);
      var fullSha = b.sha || '';
      var repoUrl = b.repo_url || '';
      var runUrl = b.run_url || '';
      var msg = truncate(b.message, 80);
      var author = b.author || '';
      var date = b.timestamp ? formatDate(b.timestamp) : '';
      var rel = b.timestamp ? relativeTime(b.timestamp) : '';
      var delay = Math.min(i, 9) * 0.05;
      var inProgress = b.status === 'in_progress';
      var failed = !inProgress && b.passed === false;
      var cardClass = 'card' + (failed ? ' failed' : '') + (inProgress ? ' in-progress' : '');

      var shaHtml = '';
      if (sha) {
        if (repoUrl && fullSha) {
          shaHtml = '<a href="' + repoUrl + '/commit/' + fullSha + '" class="sha sha-link" target="_blank" rel="noopener" onclick="event.stopPropagation()">' + sha + '</a>';
        } else {
          shaHtml = '<code class="sha">' + sha + '</code>';
        }
      }

      var statusDot = '';
      if (inProgress) {
        statusDot = '<span class="status-dot status-in-progress" title="In Progress">‚è≥</span>';
      } else if (failed) {
        statusDot = '<span class="status-dot status-fail" title="Failed">‚úó</span>';
      } else {
        statusDot = '<span class="status-dot status-pass" title="Passed">‚úì</span>';
      }

      var versionBadge = '';
      if (b.version) {
        var pillClass = b.badge === 'release' ? 'pill-green' : 'pill-yellow';
        versionBadge = '<span class="pill ' + pillClass + '">' + b.version + '</span>';
      }

      var testBadge = '';
      if (inProgress) {
        testBadge = '<span class="pill pill-in-progress">In Progress</span>';
      } else if (b.tests) {
        var tp = b.tests.passed || 0;
        var tf = (b.tests.failed || 0) + (b.tests.broken || 0);
        if (tp > 0 || tf > 0) {
          var testMsg = tf > 0 ? tp + ' passed, ' + tf + ' failed' : tp + ' passed';
          var testPill = tf > 0 ? 'pill-red' : 'pill-blue';
          testBadge = '<span class="pill ' + testPill + '">' + testMsg + '</span>';
        }
      }

      var clickHandler = inProgress ? '' : 'onclick="window.location.href=\'' + b.run + '/\'"';
      var arrowHtml = inProgress ? '' : '<svg class="arrow" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>';
      return '<div class="' + cardClass + '" style="animation-delay:' + delay + 's" ' + clickHandler + ' role="link" tabindex="0">'
        + '<div class="run"><div class="run-label">Run</div>'
        + (runUrl
          ? '<a href="' + runUrl + '" class="run-num run-link" target="_blank" rel="noopener" onclick="event.stopPropagation()" title="View CI pipeline">#' + b.run + '</a>'
          : '<div class="run-num">#' + b.run + '</div>')
        + '</div>'
        + statusDot
        + '<div class="divider"></div>'
        + '<div class="info"><div class="info-top">'
        + shaHtml
        + testBadge
        + versionBadge
        + '</div><p class="msg">' + (msg || 'No commit message') + '</p>'
        + (author ? '<p class="author">by ' + author + '</p>' : '')
        + '</div>'
        + '<div class="meta">'
        + (date ? '<div class="meta-date">' + date + '</div>' : '')
        + (rel ? '<div class="meta-rel">' + rel + '</div>' : '')
        + '</div>'
        + arrowHtml
        + '</div>';
    }

    function dateLabel(ts) {
      var d = new Date(ts);
      var now = new Date();
      var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      var target = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      var diff = (today - target) / 86400000;
      if (diff < 1 && diff >= 0) return 'Today';
      if (diff >= 1 && diff < 2) return 'Yesterday';
      return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
    }

    fetch('builds.json')
      .then(function(r) { return r.json(); })
      .then(function(builds) {
        var el = document.getElementById('builds');
        if (!builds.length) { document.getElementById('empty').classList.add('show'); return; }
        var html = '';
        var lastGroup = '';
        builds.forEach(function(b, i) {
          if (b.timestamp) {
            var group = dateLabel(b.timestamp);
            if (group !== lastGroup) {
              html += '<div class="date-group">' + group + '</div>';
              lastGroup = group;
            }
          }
          html += renderBuild(b, i);
        });
        el.innerHTML = html;
      })
      .catch(function() { document.getElementById('empty').classList.add('show'); });
  </script>
</body>
</html>
